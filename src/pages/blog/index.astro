---
import Layout from "../../layouts/Layout.astro";

import { getCollection } from "astro:content";

const blogPosts = await getCollection("blog");
let publishedPosts = blogPosts.filter((post) => post.data.published);
publishedPosts = publishedPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

const allTags = [...new Set(publishedPosts.flatMap((p) => p.data.tags || []))].sort();

function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-US", { month: "short", year: "numeric" });
}
---

<Layout title="Christopher Coyne's Blog">
  <main class="max-w-[720px] w-[90%] m-auto min-h-[90vh] pb-32">

    <header class="mb-12">
      <h1 class="page-title">Blog</h1>
      <p class="text-foreground-muted text-[16px] mt-2">Thoughts on engineering, design, and other things.</p>
    </header>

    <div class="flex gap-4 items-end mb-10">
      <input
        type="text"
        placeholder="Search posts..."
        id="searchbar"
        class="search-input"
      />
      <select id="tagFilter" class="tag-filter">
        <option value="">All tags</option>
        {allTags.map((tag) => (
          <option value={tag}>{tag}</option>
        ))}
      </select>
    </div>

    <section>
      <ul id="blog-container" class="flex flex-col">
        {
          publishedPosts.map((post: any, i: number) => (
            <li data-tags={JSON.stringify(post.data.tags || [])}>
              <a
                href={`/blog/${post.slug}`}
                class:list={[
                  "group flex items-baseline justify-between py-4",
                  i < publishedPosts.length - 1 && "border-b border-border/50"
                ]}
              >
                <div class="min-w-0">
                  <span class="text-[16px] leading-snug title group-hover:underline">{post.data.title}</span>
                  {post.data.summary && (
                    <span class="text-[14px] text-foreground-muted block mt-1">{post.data.summary}</span>
                  )}
                  {post.data.tags && post.data.tags.length > 0 && (
                    <span class="flex gap-2 mt-2">
                      {post.data.tags.map((tag: string) => (
                        <span class="tag-pill">
                          {tag}
                        </span>
                      ))}
                    </span>
                  )}
                </div>
                <span class="text-[14px] text-foreground-muted ml-6 shrink-0 tabular-nums">
                  {formatDate(post.data.date)}
                </span>
              </a>
            </li>
          ))
        }
      </ul>
    </section>
  </main>
</Layout>

<style>
  .page-title {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .search-input {
    flex: 1;
    padding: 0.6rem 0;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-size: 0.9375rem;
    outline: none;
    transition: border-color 0.2s ease;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-input:focus {
    border-bottom-color: var(--color-text);
  }

  .tag-filter {
    padding: 0.6rem 0;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-muted);
    font-size: 0.8125rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding-right: 1rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0 center;
  }

  .tag-filter:focus {
    border-bottom-color: var(--color-text);
  }

  .tag-filter option {
    background: var(--color-bg);
    color: var(--color-text);
  }

  .tag-pill {
    font-size: 0.6875rem;
    font-weight: 500;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: #f0abfc;
    color: #000;
  }
</style>

<script>
  function init() {
    const searchBar = document.getElementById("searchbar") as HTMLInputElement;
    const tagFilter = document.getElementById("tagFilter") as HTMLSelectElement;
    const blogPostsContainer = document.getElementById("blog-container");
    const blogPosts = blogPostsContainer
      ? Array.from(blogPostsContainer.getElementsByTagName("li"))
      : [];

    function filterPosts() {
      const searchText = searchBar?.value.toLowerCase() || "";
      const selectedTag = tagFilter?.value || "";

      blogPosts.forEach((post) => {
        const titleElement = post.getElementsByClassName("title")[0];
        const title = titleElement?.textContent?.toLowerCase() || "";
        const tags: string[] = JSON.parse(post.getAttribute("data-tags") || "[]");

        const matchesSearch = title.includes(searchText);
        const matchesTag = !selectedTag || tags.includes(selectedTag);

        post.style.display = matchesSearch && matchesTag ? "" : "none";
      });
    }

    if (searchBar) searchBar.addEventListener("input", filterPosts);
    if (tagFilter) tagFilter.addEventListener("change", filterPosts);
  }
  document.addEventListener("astro:page-load", () => init());
</script>
